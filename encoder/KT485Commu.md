# KT35-30-AB-RS485 编码器使用说明书 V1.2 通讯协议

## 基本信息
- **接口类型**: RS485
- **通讯协议**: Modbus-RTU
- **支持功能码**: 0X03, 0X06, 0X10
- **默认通讯参数**:
  - 数据位: 8bit
  - 停止位: 1bit
  - 校验位: 无
  - 波特率: 115200
  - 通信地址: 1 (注意：地址不能设置为 0，46，255)

## 寄存器列表

| 寄存器名称 | 地址 | 长度 | 类型 | 值/范围 | 描述 |
| --- | --- | --- | --- | --- | --- |
| 备用 | 0 | 1 | Int16 | 0 | 系统使用 |
| 模块地址 | 1 | 1 | Int16 | 1-254 | 地址 0、46、255系统使用。<br>示例：设置地址为2 `01 06 00 01 00 02 59 CB` |
| 波特率 | 2 | 1 | Int16 | 0, 2, 3, 4 | 0：115200，2：38400，3：19200，4：9600。设置波特率为115200：`01 06 00 02 00 00 28 0A` |
| 编码器位数 | 3 | 1 | Int16 | 10-14 | 如16位一圈数据范围是0-65535；12位一圈数据范围是0-4065 |
| 主动输出使能 | 4 | 1 | Int16 | 0, 1 | 1：主动输出周期2ms发送；0：关闭主动输出。启用命令：`01 06 00 04 00 01 09 CB`；禁用命令：`01 06 00 04 00 00 C8 0B` |
| A B脉冲数（每圈） | 5 | 1 | Int16 | 0-32767 | 数字999代表一圈输出1000个脉冲 |
| 位置取反 | 7 | 1 | Int16 | 0, 1 | 改变数据变化的方向，改变方向需要重新执行角度自校正。取反设置：`01 06 00 07 00 01 F9 CB` |
| 位置置零控制 | 11 | 1 | Int16 | 0, 1 | 将一个位置设置为零点。置零命令：`01 06 00 0B 00 01 39 C8` |
| 单圈位置内码 | 13 | 1 | Int16 | 0-max: 16383 | 例如，14位一圈的数据范围是0-16383；12位一圈的数据范围是0-4065。读单圈位置：`01 03 00 0D 00 01 15 C9` |
| 圈数 | 14 | 1 | Int16 | Max：±32767 | 读圈数：`01 03 00 0E 00 01 E5 C9` |
| 多圈位置内码 | 15, 16 | 2 | Int32 | XXXX | 读多圈位置：`01 03 00 0F 00 02 F4 08` 返回数据低地址表示低16位，高地址表示高16位。返回数据：`01 03 04 30 3C 00 00 35 3F` 十进制数据是12348 |
| 位置变化方向 | 17 | 1 | Int16 | 0, 1, 2 | 正方向表示数据增加的方向。0：反方向，1：正方向，2：停止 |
| 转速 | 18 | 1 | Int16 | 单位 0.1转 | 例如读回数据12345表示转速1234.5转/分钟 |
| 实际多圈角度 | 20, 21 | 2 | Int32 | 单位 0.01° | 例如读回数据123456表示角度1234.56°。读多圈实际角度：`01 03 00 14 00 02 84 0F` 返回数据低地址表示低16位，高地址表示高16位 |
| 实际单圈角度 | 22 | 1 | Int16 | 单位 0.01° | 例如读回数据（04 50）表示十进制1104，即11.04°。单圈范围0-360°。读角度：`01 03 00 16 00 01 65 CE` 返回：`01 03 02 04 50 BA B8` |
| 角度传感器故障 | 23 | 1 | Int16 | 0, 1 | 如果读回数据为1表示传感器故障 |
| 角度自校正 | 26 | 1 | Int16 | 0, 1 | 安装好磁环与板子后，磁环匀速旋转>200转/分钟，发送数据1启动角度自校正，时间最长40秒，成功返回数据0，失败返回数据2。启动命令：`01 06 00 1A 00 01 69 CD` |

## 功能码说明

### 功能码 03H：读寄存器值

#### 主机发送
| 字节 | 内容 |
| --- | --- |
| 1 | 地址 |
| 2 | 03H |
| 3 | 起始寄存器高字节 |
| 4 | 起始寄存器低字节 |
| 5 | 寄存器数量高字节 |
| 6 | 寄存器数量低字节 |
| 7 | CRC高字节 |
| 8 | CRC低字节 |

#### 从机应答
| 字节 | 内容 |
| --- | --- |
| 1 | 地址 |
| 2 | 03H |
| 3 | 字节总数 |
| 4, 5 | 寄存器数据1 |
| 6, 7 | 寄存器数据2 |
| ... | ... |
| M-1, M | 寄存器数据M |
| M+1 | CRC高字节 |
| M+2 | CRC低字节 |

### 功能码 06H：写单个寄存器值

#### 主机发送
| 字节 | 内容 |
| --- | --- |
| 1 | 地址 |
| 2 | 06H |
| 3 | 起始寄存器高字节 |
| 4 | 起始寄存器低字节 |
| 5 | 数据内容高字节 |
| 6 | 数据内容低字节 |
| 7 | CRC高字节 |
| 8 | CRC低字节 |

#### 从机应答
| 字节 | 内容 |
| --- | --- |
| 1 | 地址 |
| 2 | 06H |
| 3 | 起始寄存器高字节 |
| 4 | 起始寄存器低字节 |
| 5 | 数据内容高字节 |
| 6 | 数据内容低字节 |
| 7 | CRC高字节 |
| 8 | CRC低字节 |


## 特殊功能

1. **当忘记模块地址无法通信时可以通过下列命令获取模块地址。**
   - 获取模块地址报文格式：
     - 发送: `FF 03 00 01 00 01 C0 14`
     - 接收: `FF 03 02 00 01 50 50`

## 主动输出格式

- **数据格式**:
  | 帧头 | 帧头 | 数据 | 数据 | 数据 |
  | --- | --- | --- | --- | --- |
  | 第一字节 | 第二字节 | 第三字节 | 第四字节 | 第五字节 |
  | FF | 81 | 高8位 | 第8位 | 效验和 |

### 角度计算示例
例如接收到的数据帧为 `FF 81 EE F9 67` 的角度计算步骤如下：

1. 将 `EE F9` 转换为10进制：
   - `0XEEF9 = 61177`
   
2. 将数值换算成角度：
   - `Angle = 61177 / 65536 * 360 = 336.05度`

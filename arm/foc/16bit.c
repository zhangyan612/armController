
// ?????(USART1)??????

#define ENCODER_RESPONSE_SIZE 7

volatile uint8_t encoder_rx_buffer[ENCODER_RESPONSE_SIZE];

volatile uint8_t encoder_rx_idx = 0;

volatile int uart1_rx_timeout_counter = 0; // ???????


uint8_t rx_byte = 0, rx_byte_uart2 = 0; // ???????




// RS485 ????

#define RS485_TX_MODE() HAL_GPIO_WritePin(RS485_EN_GPIO_Port, RS485_EN_Pin, GPIO_PIN_SET)   // ???????

#define RS485_RX_MODE() HAL_GPIO_WritePin(RS485_EN_GPIO_Port, RS485_EN_Pin, GPIO_PIN_RESET) // ???????

/**

 * @brief  ??Modbus RTU?CRC16???

 * @param  data: ??????????

 * @param  length: ????

 * @retval uint16_t: 16?CRC???

 */

uint16_t crc16(uint8_t *data, uint8_t length) {

    uint16_t crc = 0xFFFF;

    for (uint8_t i = 0; i < length; i++) {

        crc ^= data[i];

        for (uint8_t j = 0; j < 8; j++) {

            if (crc & 0x0001) {

                crc >>= 1;

                crc ^= 0xA001;

            } else {

                crc >>= 1;

            }

        }

    }

    return crc;

}



/**

 * @brief  ??Modbus??????????

 */

void Send_Request(void)

{

    uint8_t request_frame[8];

    uint16_t crc;



    // ??Modbus???: [????, ???, ??????, ??????, ??????, ??????]

    request_frame[0] = 0x01; // ????

    request_frame[1] = 0x03; // ??? (0x03: ??????)

    request_frame[2] = 0x00; // ???????? (?? 13)

    request_frame[3] = 0x0D; // ????????

    request_frame[4] = 0x00; // ???????? (?? 1 ?)

    request_frame[5] = 0x01; // ????????



    // ???6????CRC16

    crc = crc16(request_frame, 6);



    // ??CRC??? (????)

    request_frame[6] = (uint8_t)(crc & 0xFF);      // CRC ???

    request_frame[7] = (uint8_t)((crc >> 8) & 0xFF); // CRC ???



    encoder_rx_idx = 0; // ?????????



    // ???????

    RS485_TX_MODE();

    // ?????8?????

    HAL_UART_Transmit(&huart1, request_frame, 8, 100);

    // ???????

    RS485_RX_MODE();



    DEBUG_PRINTF("Encoder Modbus request sent\n");

}